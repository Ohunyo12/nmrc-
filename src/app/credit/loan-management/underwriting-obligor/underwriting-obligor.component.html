<div class="ui-g">
  <div class="ui-g-12 no-padding">
      <div class="panel panel-default">
          <div class="panel-heading">
              <div class="row">
                  <div class="col-md-12">
                      <h2 class="panel-title pull-left">
                          <!-- PMB Underwriting Checklist -->
                          Obligor Loan Assessment
                      </h2>
                  </div>
              </div>
          </div>

          <!-- Loans Table -->
          <!-- <p-tabView [activeIndex]="activeSearchTabindex" (onChange)="onSearchTabChange($event)">
              <p-dataTable 
                  [value]="loans" 
                  [paginator]="true" 
                  [rows]="10" 
                  [(selection)]="selectedLoan"  
                  [rowsPerPageOptions]="[10, 20, 30]" 
                  [totalRecords]="itemTotal" 
                  >
                  <p-column selectionMode="single" [style]="{'width':'38px'}">
                      <ng-template let-loan="rowData" pTemplate="body">
                          <p-radioButton name="selectedLoan" [value]="loan" [(ngModel)]="selectedLoan"></p-radioButton>
                      </ng-template>
                  </p-column>
          
                  <p-column field="loanId" header="Loan Reference Number" sortable="true"  [filter]="true"></p-column>
                  <p-column field="nhfnumber" header="NHF Number" sortable="true"  [filter]="true"></p-column>
                  <p-column field="productCode" header="Product Name" sortable="true" [filter]="true"></p-column>
                 <p-column field="tenor" header="Tenor" sortable="true"  [filter]="true"></p-column>
                  <p-column field="amount" header="Amount" sortable="true"  [filter]="true"></p-column>
                  <p-column [style]="{'width':'130px', 'text-align':'center'}">
                      <ng-template let-loan="rowData" pTemplate="body">
                          <button pButton type="button" label="Checklist"
                                  (click)="openUWSModal(loan)"
                                 >
                          </button>
                      </ng-template>
                  </p-column>     

              </p-dataTable>
          </p-tabView> -->

          <p-tabView
          [activeIndex]="activeSearchTabindex"
          (onChange)="onSearchTabChange($event)"
        >
        <form>
          <div class="panel-body">
              <button pButton type="button" label="Approve for Refinancing" 
                  class="ui-button-success custom-button" 
                  [disabled]="isPmbApprovalDisabled"
                  (click)="approveChecklistLoans()"
                  style="width: 200px; height: 40px; font-size: 13px; font-weight: bold;
                         background-color: #1e6f5c; border-color: #1a5c4d; color: white; 
                         display: flex; align-items: center; justify-content: center; gap: 10px;
                         border-radius: 8px; padding: 10px 12px; transition: 0.3s ease-in-out;">
                  
                  <span class="glyphicon glyphicon-check" style="font-size: 20px;"></span> 
              </button>
          </div>
                                       
  </form>
          <!-- Custom Table Without PrimeNG -->
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead
                style="
                  border: 2px solid #062c58;
                  background-color: #062c58;
                  color: white;
                  text-align: left;
                "
              >
                <tr>
                  <th style="width: 1%"></th>
                  <!-- Radio Button Column -->
                  <th style="width: 15%">Reference Number</th>
                  <th style="width: 10%">PMB Name</th>
                  <th style="width: 10%">Total Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let loan of loans">
                  <td>
                    <input
                      type="radio"
                      name="selectedLoan"
                      [value]="loan.refinanceNumber"
                      [(ngModel)]="selectedLoanId"
                      (click)="viewLoanDetails(loan.refinanceNumber, $event)"
                      (change)="onSelectionChange()"
                    />
                  </td>
                  <td>{{ loan.refinanceNumber }}</td>                
                  <td>{{ loan.pmbName }}</td> 
                  <td>{{ loan.totalAmount | number:'.2' }}</td> 
                </tr>
              </tbody>
            </table>
            <h3
              *ngIf="loanDetails.length > 0"
              style="margin-top: 20px; margin-left: 20px;  color: #05101b; font-weight: bold"
            >
              Loan Details for {{ selectedLoanId }}
            </h3>
            <!-- <table *ngIf="loanDetails.length > 0" class="table table-bordered">
              <thead
                style="
                  border: 2px solid #062c58;
                  background-color: #062c58;
                  color: white;
                  text-align: left;
                "
              >
                <tr>
                  <th>Customer Name</th>
                  <th>NHF Number</th>
                  <th>Facility Name</th>
                  <th>Amount</th>
                  <th>Tenor</th>
                  <th>Rate</th>
                  <th style="text-align: center;"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detail of loanDetails">
                  <td>{{ detail.customerName }}</td>
                  <td>{{ detail.nhfnumber }}</td>
                  <td>{{ detail.productCode }}</td>
                  <td>{{ detail.amount | number: '.2' }}</td>
                  <td>{{ detail.tenor }} days</td>
                  <td>{{ detail.rate }}%</td>
                  <td [style]="{'width':'130px', 'text-align':'center'}">
                      <button pButton type="button" label="Checklist" (click)="openUWSModal(detail)">
                      </button>
                    </td>                      
                </tr>
              </tbody>
            </table> -->
            <table *ngIf="loanDetails.length > 0" class="table table-bordered">
              <thead
                style="
                  border: 2px solid #062c58;
                  background-color: #062c58;
                  color: white;
                  text-align: left;
                "
              >
                <tr>
                  <th>Customer Name</th>
                  <th>NHF Number</th>
                  <th>Facility Name</th>
                  <th>Amount</th>
                  <th>Tenor</th>
                  <th>Rate</th>
                  <th style="text-align: center;"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detail of loanDetails">
                  <td>{{ detail.customerName }}</td>
                  <td>{{ detail.nhfnumber }}</td>
                  <td>{{ detail.productCode }}</td>
                  <td>{{ detail.amount | number: '.2' }}</td>
                  <td>{{ detail.tenor }} days</td>
                  <td>{{ detail.rate }}%</td>
                  <td [style]="{'width':'130px', 'text-align':'center'}">
                    <button pButton type="button" label="Checklist" (click)="openUWSModal(detail)" [disabled]="detail.itemAvailable === 1">
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            
            <!-- Display "No Loan Record Found" message when loanDetails is empty -->
            <div *ngIf="loanDetails.length === 0 && !loading" class="text-center" style="margin-top: 10px; font-weight: bold; color: red;">
              {{ noLoanMessage }}
            </div>
            
          </div>
  
        
          <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px;">
              <button pButton label="Previous" icon="pi pi-angle-left" class="p-button-outlined" (click)="previousPage()" [disabled]="currentPage === 1"></button>
              <span style="font-weight: bold;"> Page {{ currentPage }} of {{ totalPages }} </span>
              <button pButton label="Next" icon="pi pi-angle-right" class="p-button-outlined" (click)="nextPage()" [disabled]="currentPage === totalPages"></button>
            </div>
        </p-tabView>


          

          <p-dialog [(visible)]="isUWSModalVisible" [modal]="true" header="Uniform Underwriting Standard"
          [style]="{ width: '40%', maxWidth: '80vw', maxHeight: '75vh', margin: 'auto', display: 'flex', flexDirection: 'column', alignItems: 'center' }"
          [closable]="false">

    <div style="position: absolute; top: 10px; right: 15px; cursor: pointer;
                width: 30px; height: 30px; display: flex; align-items: center;
                justify-content: center; border: 2px solid red; border-radius: 5px;
                background-color: white;" 
         (click)="closeUWSModal()">
        <span style="font-size: 20px; color: red; font-weight: bold;">&times;</span>
    </div>

    <div style="padding: 15px; width: 100%; text-align: center;">

        <!-- Modal Title -->
        <h3 style="font-weight: bold;">Uniform Underwriting Standard for {{ selectedLoanDetail?.customerName }}</h3>

        <!-- Form -->
        <form (ngSubmit)="saveUWSDetails()" style="width: 100%;">
          <div style="max-height: 60vh; overflow-y: auto; padding: 0; margin: 0; width: 100%; border: 1px solid #ddd;">
              <table class="table table-bordered" 
                     style="width: 100%; font-size: 14px; text-align: left; 
                            border-collapse: collapse; table-layout: fixed; 
                            margin: 0; padding: 0;">
                  <thead style="position: sticky; top: 0; background-color: #f5f5f5; z-index: 100; margin: 0; padding: 0;">
                      <tr style="text-align: center; color: black; border-bottom: 2px solid #ddd;">
                          <th style="padding: 10px; width: 20%;">Item</th>
                          <th style="padding: 10px; width: 30%;">Description</th>
                          <th style="padding: 10px; width: 20%;">Option</th>
                          <th style="padding: 10px; width: 15%;">Defer Date</th>
                          <th style="padding: 10px; width: 15%;">Upload File</th>
                      </tr>
                  </thead>
          
                  <tbody *ngIf="uwsList && uwsList.length > 0; else noData">
                      <tr *ngFor="let uws of uwsList" style="border-bottom: 1px solid #ddd;">
                          <td style="padding: 8px;">{{ uws.item }}</td>
                          <td style="padding: 8px;">{{ uws.description }}</td>
                          <td style="padding: 8px; text-align: center;">
                              <div style="display: flex; flex-direction: column; gap: 5px; align-items: start;">
                                  <label><input type="radio" [(ngModel)]="uws.option" value="Yes" [name]="'option' + uws.id"> Met</label>
                                  <label><input type="radio" [(ngModel)]="uws.option" value="No" [name]="'option' + uws.id"> Not Met</label>
                                  <label><input type="radio" [(ngModel)]="uws.option" value="Waiver" [name]="'option' + uws.id"> Waiver</label>
                                  <label><input type="radio" [(ngModel)]="uws.option" value="Deferred" [name]="'option' + uws.id" (change)="onOptionChange(uws)"> Defer</label>
                              </div>
                          </td>
                          <td>
                              <ng-container *ngIf="uws.option === 'Deferred'; else showNA">
                                  <input type="date" [(ngModel)]="uws.deferredDate" [name]="'deferredDate' + uws.id" 
                                         class="form-control" (change)="onDeferredDateChange(uws)"  [min]="today"
                                         style="appearance: none; background-color: #fff; border: 1px solid #ccc; padding: 8px 12px; border-radius: 5px; font-size: 14px; cursor: pointer; width: 100%;">
                              </ng-container>
                              <ng-template #showNA>N/A</ng-template>
                          </td>
                          <!-- <td style="padding: 8px; text-align: center;">
                              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                  <input type="file" id="fileInput-{{uws.id}}" (change)="onFileSelect($event, uws.id)" accept=".jpeg,.jpg,.png,.pdf,.doc,.docx" multiple style="display: none;">
                                  <label for="fileInput-{{uws.id}}" style="display: inline-block; background-color: #007bff; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; text-align: center; min-width: 130px;">
                                      üìÅ Choose File
                                  </label>
                                  <span id="fileNameDisplay-{{uws.id}}" style="font-size: 12px; color: #555; min-height: 16px; display: block;">No file selected</span>
                              </div>
                          </td> -->
                          <td style="padding: 8px; text-align: center;">
                              <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                  <input type="file" id="fileInput-{{uws.id}}" (change)="onFileSelect($event, uws.id)" 
                                         accept=".jpeg,.jpg,.png,.pdf,.doc,.docx" multiple 
                                         [disabled]="uws.option === 'Deferred'" style="display: none;">
                                  
                                  <label for="fileInput-{{uws.id}}" 
                                         [style.background-color]="uws.option === 'Deferred' ? '#ccc' : '#007bff'"
                                         [style.cursor]="uws.option === 'Deferred' ? 'not-allowed' : 'pointer'"
                                         style="display: inline-block; color: white; padding: 8px 15px; border-radius: 5px; 
                                                font-size: 14px; font-weight: bold; text-align: center; min-width: 130px;">
                                      üìÅ Choose File
                                  </label>
                          
                                  <span id="fileNameDisplay-{{uws.id}}" 
                                        style="font-size: 12px; color: #555; min-height: 16px; display: block;">
                                      No file selected
                                  </span>
                              </div>
                          </td>
                          
                      </tr>
                  </tbody>
                  <ng-template #noData>
                      <tr>
                          <td colspan="5" style="text-align: center;">No data available</td>
                      </tr>
                  </ng-template>
              </table>
          </div>            
      
          <!-- Action Buttons (Sticky at Bottom) -->
          <!-- <div style="position: sticky; bottom: 0; background: white; padding: 10px; 
          display: flex; justify-content: flex-end; gap: 15px; width: 100%; 
          margin-top: 0;">
          <button type="button" class="ui-button-secondary"
          (click)="clearForm()" 
          style="background-color: #ffc107; color: black; border: none; padding: 12px 20px; 
              border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; 
              min-width: 120px; font-size: 13px;">
          Clear
          </button>
          <button type="submit" class="ui-button-success"
          style="background-color: #28a745; color: white; border: none; padding: 12px 20px; 
              border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; 
              min-width: 120px; font-size: 13px;">
          Submit
          </button>
          </div> -->
          <div style="position: sticky; bottom: 0; background: white; padding: 15px; 
          display: flex; justify-content: flex-end; gap: 15px; border-top: 1px solid #ddd;"> 
              <button type="button" (click)="clearForm()" 
                      style="background-color: #ffc107; color: black; padding: 12px 20px; 
                          border-radius: 5px; font-weight: bold; min-width: 120px;">
                  Clear
              </button>
              <button type="submit"
                      style="background-color: #28a745; color: white; padding: 12px 20px; 
                          border-radius: 5px; font-weight: bold; min-width: 120px;">
                  Submit
              </button>
          </div>
      </form>
      
    </div>
          </p-dialog>



      </div>
  </div>
</div>