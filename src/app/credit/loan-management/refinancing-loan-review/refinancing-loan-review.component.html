<div class="ui-g">
  <div class="ui-g-12 no-padding">
      <div class="panel panel-default">
          <div class="panel-heading">
              <div class="row">
                  <div class="col-md-12">
                      <h2 class="panel-title pull-left">
                          Obligor Risk Assessment & Approval
                      </h2>
                  </div>
              </div>
          </div>

 
          <p-tabView
          [activeIndex]="activeSearchTabindex"
          (onChange)="onSearchTabChange($event)"
        >
        <form>

          <div class="panel-body">                
                      <button pButton type="button" label="Send for Final Approval" 
                          class="ui-button-success custom-button" 
                          [disabled]="isPmbApprovalDisabled"
                          (click)="sendForApproval()"
                          style="width: 200px; height: 40px; font-size: 13px; font-weight: bold;
                           background-color: #1e6f5c; border-color: #1a5c4d; color: white; 
                           display: flex; align-items: center; justify-content: center; gap: 10px;
                           border-radius: 8px; padding: 10px 12px; transition: 0.3s ease-in-out;">
                          <span class="glyphicon glyphicon-send" style="font-size: 20px;"></span> 
                      </button>           
                  </div>                                        
        </form>
          <!-- Custom Table Without PrimeNG -->
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead
                style="
                  border: 2px solid #062c58;
                  background-color: #062c58;
                  color: white;
                  text-align: left;
                "
              >
                <tr>
                  <th style="width: 1%"></th>
                  <!-- Radio Button Column -->
                  <th style="width: 15%">Reference Number</th>
                  <th style="width: 10%">PMB Name</th>
                  <th style="width: 10%">Total Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let loan of displayedLoans">
                  <td>
                    <input
                      type="radio"
                      name="selectedLoan"
                      [value]="loan.refinanceNumber"
                      [(ngModel)]="selectedLoan"
                      (click)="viewLoanDetails(loan.refinanceNumber)"
                      (change)="onSelectionChange()"
                    />
                  </td>
                  <td>{{ loan.refinanceNumber }}</td>                
                  <td>{{ loan.pmbName }}</td> 
                  <td>{{ loan.totalAmount | number:'.2' }}</td> 
                </tr>
              </tbody>
            </table>
            <h3
              *ngIf="loanDetails.length > 0"
              style="margin-top: 20px; margin-left: 20px;  color: #05101b; font-weight: bold"
            >
              Loan Details for {{ selectedLoanId }}
            </h3>
            <table *ngIf="loanDetails.length > 0" class="table table-bordered">
              <thead style="border: 2px solid #062c58; background-color: #062c58; color: white; text-align: left;">
                <tr>
                  <th></th>
                  <th>Customer Name</th>
                  <th>NHF Number</th>
                  <th>Facility Name</th>
                  <th>Amount</th>
                  <th>Tenor</th>
                  <th>Rate</th>
                  <th style="text-align: center;"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detail of loanDetails">
                  <td>
                    <input
                      type="radio"
                      name="loanDetailSelection" 
                      [value]="detail"
                      [checked]="selectedLoanDetail === detail"
                      (change)="onLoanSelectionChange(detail)"
                    />
                  </td>
                  <td>{{ detail.customerName }}</td>
                  <td>{{ detail.nhfnumber }}</td>
                  <td>{{ detail.productCode }}</td>
                  <td>{{ detail.amount | number: '.2' }}</td>
                  <td>{{ detail.tenor }} days</td>
                  <td>{{ detail.rate }}%</td>
                  <td style="width: 320px; text-align: center;">
                    <div style="display: flex; justify-content: center; gap: 4px;">
                      <button
                      pButton
                      type="button"
                      label="Review Checklist"
                      (click)="openUWSModal(detail)"
                      [disabled]="disabledLoans.has(detail.loanId)"
                      class="p-button-secondary"
                      style="width: 100px; height: 32px; font-size: 12px; padding: 0; line-height: 1.2; text-align: center; display: flex; align-items: center; justify-content: center; white-space: normal; overflow: hidden; text-overflow: ellipsis;"
                    ></button>
                      <button
                        pButton
                        type="button"
                        label="Approve"
                        (click)="approveReviewLoans()"
                        class="ui-button-success"
                        [disabled]="selectedLoanDetail !== detail"
                        style="width: 100px; height: 32px; font-size: 12px;"
                      ></button>
                      <button
                        pButton
                        type="button"
                        label="Decline"
                        (click)="disApproveReviewLoans()"
                        class="ui-button-danger"
                        [disabled]="selectedLoanDetail !== detail"
                        style="width: 100px; height: 32px; font-size: 12px;"
                      ></button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            
            
            <!-- Display "No Loan Record Found" message when loanDetails is empty -->
            <div *ngIf="loanDetails.length === 0 && !loading" class="text-center" style="margin-top: 10px; font-weight: bold; color: red;">
              {{ noLoanMessage }}
            </div>
          </div>
  
          <!-- Pagination Controls -->
          <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px;">
              <button pButton label="Previous" icon="pi pi-angle-left" class="p-button-outlined" 
                (click)="previousPage()" [disabled]="currentPage === 1">
              </button>
            
              <span style="font-weight: bold;"> Page {{ currentPage }} of {{ totalPages }} </span>
            
              <button pButton label="Next" icon="pi pi-angle-right" class="p-button-outlined" 
                (click)="nextPage()" [disabled]="currentPage >= totalPages">
              </button>
            </div>
            
        </p-tabView>
          <!-- Checklist Modal -->

          <p-dialog [(visible)]="isUWSModalVisible" [modal]="true" header="Uniform Underwriting Standard"
                      [style]="{ width: '40%', maxWidth: '80vw', maxHeight: '75vh', margin: 'auto', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', 
                      position: 'fixed', 
                      top: '50%', 
                      left: '50%', 
                      transform: 'translate(-8%, -0%)' }"
                      [closable]="false">
            
                <div style="position: absolute; top: 10px; right: 15px; cursor: pointer;
                            width: 30px; height: 30px; display: flex; align-items: center;
                            justify-content: center; border: 2px solid red; border-radius: 5px;
                            background-color: white;" 
                     (click)="closeUWSModal()">
                    <span style="font-size: 20px; color: red; font-weight: bold;">&times;</span>
                </div>
            
                <div style="padding: 15px; width: 100%; text-align: center;">
            
                    <!-- Modal Title -->
                    <h3 style="font-weight: bold;">Uniformed Underwriting Standard for {{ selectedLoanDetail?.refinanceNumber }}</h3>
            
                    <!-- Checklist Form -->
                    <form (ngSubmit)="saveUUSDetails()" style="width: 100%;">
                      <div style="max-height: 60vh; overflow-y: auto; padding: 10px; margin: 0; width: 100%; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                          
                          <!-- Approval Comment Section -->
                          <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                              <label for="approvedComment" style="font-weight: bold; font-size: 14px; color: #333;">
                                  Approval Comments:
                              </label>
                              <textarea id="approvedComment" [(ngModel)]="approvedComment" name="approvedComment" 
                                        placeholder="Provide your approval comments here..." required
                                        style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; 
                                               border-radius: 8px; font-size: 14px; resize: none; background: white;"></textarea>
                          </div>
                  
                          <!-- Checklist Table -->
                          <table class="table table-bordered" style="width: 100%; font-size: 14px; text-align: left; border-collapse: collapse; 
                          margin: 0; padding: 0;">
                  <thead style="position: sticky; top: 0; background-color: #464f58; color: white; z-index: 100;">
                      <tr style="text-align: center;">
                          <th style="padding: 10px;">Item</th>
                          <th style="padding: 10px;">Description</th>
                          <th style="padding: 10px;">Option</th>
                          <th style="padding: 10px;">Deferred Date</th>
                          <th style="padding: 10px;">Supporting Documents</th>
                         
                      </tr>
                  </thead>

                  <tbody *ngIf="uwsList && uwsList.length > 0; else noData">
                      <tr *ngFor="let uws of uwsList" 
                          [ngStyle]="{'background-color': getRowColor(uws.option)}"
                          style="border-bottom: 1px solid #ddd;">
                        
                        <!-- UWS Name Column -->
                        <td style="padding: 8px;">{{ uws.item }}</td>
                    
                        <!-- Description Column -->
                        <td style="padding: 8px;">{{ uws.description }}</td>
                        
                        <!-- Options (Disabled) -->
                        <td style="padding: 8px; text-align: center; vertical-align: middle;">
                          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 5px;">
                              <label style="display: flex; align-items: center; gap: 5px;">
                                  <input type="radio" [(ngModel)]="uws.option" value="Yes" [name]="'option' + uws.id" disabled> Met
                              </label>
                              <label style="display: flex; align-items: center; gap: 5px;">
                                  <input type="radio" [(ngModel)]="uws.option" value="No" [name]="'option' + uws.id" disabled> Not Met
                              </label>
                              <label style="display: flex; align-items: center; gap: 5px;">
                                  <input type="radio" [(ngModel)]="uws.option" value="Waiver" [name]="'option' + uws.id" disabled> Waiver
                              </label>
                              <label style="display: flex; align-items: center; gap: 5px;">
                                  <input type="radio" [(ngModel)]="uws.option" value="Deferred" [name]="'option' + uws.id" disabled> Deferred
                              </label>
                          </div>
                        </td>                                                             
                       
                        <!-- Defer Date -->
                        <td>
                            <ng-container *ngIf="uws.option === 'Deferred'; else showNA">
                                <input type="date" [(ngModel)]="uws.deferredDate" [name]="'deferredDate' + uws.id" 
                                        class="form-control" readonly disabled
                                        style="border: 1px solid #ccc; padding: 8px 12px; border-radius: 5px; width: 100%;">
                            </ng-container>
                            <ng-template #showNA>N/A</ng-template>
                        </td>
                      
                        <!-- Action Column -->
                        <td style="padding: 8px; text-align: center; vertical-align: middle;">
                          <div style="display: flex; justify-content: center; align-items: center;">
                              <button *ngIf="uws.option !== 'Deferred'" type="button" class="ui-button ui-button-primary" (click)="viewDocument(uws)">
                                  Preview
                              </button>
                          </div>
                      </td>
                      </tr>
                  </tbody>

                  <ng-template #noData>
                      <tr>
                          <td colspan="5" style="text-align: center; padding: 10px; color: red;">No data available</td>
                      </tr>
                  </ng-template>
              </table>

                      </div>            
                  
                      <!-- Action Buttons -->
                      <div style="position: sticky; bottom: 0; background: white; padding: 15px; 
                                  display: flex; justify-content: flex-end; gap: 15px; border-top: 1px solid #ddd;">
                          
                          <button type="button" (click)="clearForm()" 
                                  style="background-color: #ffc107; color: black; padding: 12px 20px; 
                                         border-radius: 5px; font-weight: bold; min-width: 120px;">
                              Clear
                          </button>
                          <button type="submit"
                                  style="background-color: #28a745; color: white; padding: 12px 20px; 
                                         border-radius: 5px; font-weight: bold; min-width: 120px;">
                              Submit
                          </button>
                      </div>
                  </form>                
                </div>
            </p-dialog> 

            <p-dialog [(visible)]="isPreviewModalVisible" [modal]="true" [style]="getModalStyle()"
            [closable]="true" (onHide)="closePreviewModal()" [draggable]="false"> 
            <div style="display: flex; justify-content: center; align-items: center; padding: 10px; position: relative;">
                <h3 style="margin: 0; flex: 1; text-align: center;">
                    Document Preview for {{ selectedLoan?.customerName }}
                </h3>
            
                <div style="cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center;
                            justify-content: center; border: 2px solid red; border-radius: 5px; background-color: white;
                            position: absolute; right: 10px;"
                    (click)="closePreviewModal()">
                    <span style="font-size: 20px; color: red; font-weight: bold;">&times;</span>
                </div>
            </div>    

            <!-- Horizontal Line -->
            <hr style="margin: 0 10px; border-top: 1px solid gray;">

            <div style="padding: 15px; width: 100%; text-align: center;">
                <!-- Display Images -->
                <div *ngIf="fileType?.includes('image')" 
                    style="display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <img [src]="selectedDocumentUrl" 
                        [style.transform]="'scale(' + zoomLevel + ')'"
                        style="max-height: 500px; object-fit: contain; transition: transform 0.3s ease-in-out; cursor: grab;"
                        (wheel)="onScrollZoom($event)" 
                        (mousedown)="startDrag($event)" 
                        (click)="toggleZoom()" />
                </div>

                <!-- Display PDFs -->
                <div *ngIf="fileType === 'application/pdf'" style="overflow: hidden; position: relative;">
                    <iframe #pdfFrame [src]="selectedDocumentUrl" width="100%" height="550px"
                        (wheel)="onScrollZoom($event)" style="cursor: grab; transform-origin: center;"></iframe>
                </div>

                <!-- Display Word Documents (DOCX, DOC) -->
                <div *ngIf="fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' 
                            || fileType === 'application/msword'" 
                    style="overflow: hidden; position: relative;">
                    <iframe #docFrame [src]="selectedDocumentUrl" width="100%" height="550px"
                        (wheel)="onScrollZoom($event)" style="cursor: grab; transform-origin: center;"></iframe>
                </div>

                <!-- Display Error for Unsupported Files -->
                <div *ngIf="!fileType?.includes('image') && fileType !== 'application/pdf' 
                            && fileType !== 'application/msword' 
                            && fileType !== 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'"
                    style="color: red; font-weight: bold;">
                    Unsupported file type.
                </div>

                <!-- Zoom Controls -->
                <!-- <div style="margin-top: 10px;">
                    <button (click)="zoomIn()">➕ Zoom In</button>
                    <button (click)="zoomOut()">➖ Zoom Out</button>
                </div> -->
            </div>
        </p-dialog>
         
      </div>
  </div>
</div>